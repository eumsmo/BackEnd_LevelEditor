using UnityEngine;
using UnityEngine.Networking;
using UnityEngine.SceneManagement;
using System.Collections;

public class GameManager : MonoBehaviour {
    public static GameManager instance;
    
    public MapManager mapManager;
    public Mapa mapa;

    public System.Action OnPause, OnUnpause;

    public string winScene, loseScene;

    void Awake() {
        if (instance == null) {
            instance = this;
        } else {
            Destroy(gameObject);
        }
    }

    void Start() {
        if (PlayerPrefs.HasKey("linkCustom"))  {
            string link = PlayerPrefs.GetString("linkCustom");
            CarregarMapaOnline(link);
        } else {
            CarregarMapaCampanha();
        }
    }

    void Update() {
        if (Input.GetKeyDown(KeyCode.Escape)) {
            if (Time.timeScale == 1f) {
                Pausar();
            } else {
                Despausar();
            }
        }
    }

    public void Pausar() {
        Time.timeScale = 0f;
        OnPause?.Invoke();
    }

    public void Despausar() {
        Time.timeScale = 1f;
        OnUnpause?.Invoke();
    }

    public void Venceu() {
        Despausar();
        SceneManager.LoadScene(winScene);
    }

    public void Perdeu() {
        Despausar();
        SceneManager.LoadScene(loseScene);
    }

    #region Carregar Mapa

    public void CarregarMapa(string json) {
        if (json == "") return;
        
        MapaData mapaData = JsonUtility.FromJson<MapaData>(json);
        Mapa mapaCarregado = MapaAdapter.GetMapa(mapaData);
        mapManager.SetMapa(mapaCarregado);
    }

    public void CarregarMapaCampanha() {
        string nomeResource = "mapa";
        TextAsset mapaText = Resources.Load<TextAsset>(nomeResource);
        if (mapaText != null) {
            CarregarMapa(mapaText.text);
        } else {
            Debug.LogError($"Erro ao carregar o mapa: {nomeResource} n√£o encontrado.");
        }
    }

    public void CarregarMapaOnline(string link) {
        StartCoroutine(CarregarMapaCoroutine(link));
    }

    IEnumerator CarregarMapaCoroutine(string link) {
        using (UnityWebRequest webRequest = UnityWebRequest.Get(link)) {
            yield return webRequest.SendWebRequest();

            if (webRequest.result == UnityWebRequest.Result.ConnectionError || webRequest.result == UnityWebRequest.Result.ProtocolError) {
                Debug.LogError($"Erro ao carregar o mapa: {webRequest.error}");
            } else {
                CarregarMapa(webRequest.downloadHandler.text);
            }
        }
    }

    #endregion Carregar Mapa
   
}
