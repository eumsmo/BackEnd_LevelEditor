using UnityEngine;

public class Player : MonoBehaviour {
    public static Player instance;

    public GameObject virusPrefab;
    [HideInInspector] public Virus virus;

    public Controlavel controlando;

    void Awake() {
        if (instance == null) {
            instance = this;
        } else {
            Destroy(gameObject);
        }
    }

    void Update() {
        Controlavel controladoAtual = controlando ?? virus;
        if (controladoAtual == null) return;

        Vector2 direcao = Vector2.zero;
        if (Input.GetKeyDown(KeyCode.W)) direcao = -Vector2.up;
        else if (Input.GetKeyDown(KeyCode.S)) direcao = -Vector2.down;
        else if (Input.GetKeyDown(KeyCode.A)) direcao = Vector2.left;
        else if (Input.GetKeyDown(KeyCode.D)) direcao = Vector2.right;

        if (direcao.magnitude > 0) {
            controladoAtual.RecebeInput(direcao);
        }

        if (Input.GetKeyDown(KeyCode.Space)) {
            controladoAtual.FazerAcao();
        }
    }

    private void SurgirVirus(int x, int y) {
        if (virus == null) {
            virus = Instantiate(virusPrefab).GetComponent<Virus>();
            virus.InicializarObjeto();
            virus.Teletransportar(x, y);
        } else {
            virus.Teletransportar(x, y);
        }

        virus.gameObject.SetActive(true);
    }

    public bool SoltarVirus() {
        if (controlando == null) return false;

        Objeto objeto = controlando.objeto;
        GridPos posicaoEmFrente = new GridPos(objeto.posicao.x, objeto.posicao.y);
        posicaoEmFrente.Mover(objeto.direcao);

        if (MapManager.instance.CanMoveTo(posicaoEmFrente.x, posicaoEmFrente.y)) {
            SurgirVirus(posicaoEmFrente.x, posicaoEmFrente.y);

            controlando.HandleDefaultDesinfectado();
            controlando = null;
            
            return true;
        } else {
            Objeto objetoEmFrente = MapManager.instance.GetObjetoAt(posicaoEmFrente.x, posicaoEmFrente.y);
            if (objetoEmFrente != null) {
                GameObject objetoEmFrenteGameObject = MapManager.instance.GetInstance(objetoEmFrente);
                if (objetoEmFrenteGameObject == null) return false;

                Controlavel controlavel = objetoEmFrenteGameObject.GetComponent<Controlavel>();
                if (controlavel != null) {
                    return InfectarObjeto(controlavel);
                }
            }
        }

        return false;
    }

    public bool InfectarObjeto(Controlavel controlavel) {
        Controlavel controladoAtual = controlando ?? virus;

        if (controladoAtual == null || controlavel == null) return false;

        // Checa se estÃ¡ em Range
        Objeto objeto = controlavel.objeto;
        Objeto objetoAtual = controladoAtual.objeto;

        int xDif = Mathf.Abs(objetoAtual.posicao.x - objeto.posicao.x);
        int yDif = Mathf.Abs(objetoAtual.posicao.y - objeto.posicao.y);

        if (xDif > 1 || yDif > 1) return false;
        if (xDif == 1 && yDif == 1) return false;

        // Infecta o objeto
        if (controlando != null) controlando.HandleDefaultDesinfectado();
        controlando = controlavel;
        controlando.HandleDefaultInfectado();

        return true;
    }
}

